{% extends "base.html" %}

{% block title %}Reports - Daily Expense & Income Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-graph-up"></i> Reports
            </h1>
            <div class="btn-group" role="group">
                <a href="{{ url_for('reports_page', type='daily') }}" 
                   class="btn {% if report_type == 'daily' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    Daily
                </a>
                <a href="{{ url_for('reports_page', type='weekly') }}" 
                   class="btn {% if report_type == 'weekly' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    Weekly
                </a>
                <a href="{{ url_for('reports_page', type='monthly') }}" 
                   class="btn {% if report_type == 'monthly' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    Monthly
                </a>
                <a href="{{ url_for('reports_page', type='yearly') }}" 
                   class="btn {% if report_type == 'yearly' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    Yearly
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Report Controls -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row align-items-end">
            <input type="hidden" name="type" value="{{ report_type }}">
            <div class="col-md-4">
                <label for="reportDate" class="form-label">Select Date</label>
                <input type="date" class="form-control" id="reportDate" name="date" 
                       value="{{ target_date.isoformat() }}">
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-arrow-clockwise"></i> Update Report
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Report Summary -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-bar-chart"></i> 
            {% if report_type == 'daily' %}
                Daily Report - {{ report_data.date_formatted }}
            {% elif report_type == 'weekly' %}
                Weekly Report - {{ report_data.week_range }}
            {% elif report_type == 'monthly' %}
                Monthly Report - {{ report_data.month }}
            {% elif report_type == 'yearly' %}
                Yearly Report - {{ report_data.year }}
            {% endif %}
        </h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="text-success">
                    <i class="bi bi-arrow-up-circle display-6"></i>
                    <div class="fw-bold fs-3">{{ report_data.summary.total_income | currency }}</div>
                    <div class="text-muted">Total Income</div>
                    <small class="text-muted">{{ report_data.summary.income_count }} transactions</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-danger">
                    <i class="bi bi-arrow-down-circle display-6"></i>
                    <div class="fw-bold fs-3">{{ report_data.summary.total_expenses | currency }}</div>
                    <div class="text-muted">Total Expenses</div>
                    <small class="text-muted">{{ report_data.summary.expense_count }} transactions</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="{% if report_data.summary.net_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                    <i class="bi bi-{% if report_data.summary.net_balance >= 0 %}plus{% else %}dash{% endif %}-circle display-6"></i>
                    <div class="fw-bold fs-3">{{ report_data.summary.net_balance | currency }}</div>
                    <div class="text-muted">Net Balance</div>
                    <small class="text-muted">
                        {% if report_data.summary.net_balance >= 0 %}
                            Surplus
                        {% else %}
                            Deficit
                        {% endif %}
                    </small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-info">
                    <i class="bi bi-list-ol display-6"></i>
                    <div class="fw-bold fs-3">{{ report_data.summary.transaction_count }}</div>
                    <div class="text-muted">Total Transactions</div>
                    <small class="text-muted">All types</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Charts -->
    <div class="col-lg-8 mb-4">
        <!-- Income vs Expenses Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart"></i> Income vs Expenses
                </h5>
            </div>
            <div class="card-body">
                <canvas id="incomeExpenseChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Category Breakdown Chart -->
        {% if report_data.category_breakdown %}
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bar-chart"></i> Category Breakdown
                </h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" width="400" height="300"></canvas>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Breakdown Details -->
    <div class="col-lg-4">
        <!-- Period Breakdown -->
        {% if report_type == 'weekly' and report_data.daily_breakdown %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-week"></i> Daily Breakdown
                </h5>
            </div>
            <div class="card-body">
                {% for day in report_data.daily_breakdown %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="fw-bold">{{ day.date_formatted }}</div>
                            <small class="text-muted">{{ day.transaction_count }} transactions</small>
                        </div>
                        <div class="text-end">
                            <div class="{% if day.summary.net_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ day.summary.net_balance | currency }}
                            </div>
                        </div>
                    </div>
                    {% if not loop.last %}<hr class="my-2">{% endif %}
                {% endfor %}
            </div>
        </div>
        {% elif report_type == 'monthly' and report_data.weekly_breakdown %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-month"></i> Weekly Breakdown
                </h5>
            </div>
            <div class="card-body">
                {% for week in report_data.weekly_breakdown %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="fw-bold">Week {{ week.week_number }}</div>
                            <small class="text-muted">{{ week.week_range }}</small>
                        </div>
                        <div class="text-end">
                            <div class="{% if week.summary.net_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ week.summary.net_balance | currency }}
                            </div>
                        </div>
                    </div>
                    {% if not loop.last %}<hr class="my-2">{% endif %}
                {% endfor %}
            </div>
        </div>
        {% elif report_type == 'yearly' and report_data.monthly_breakdown %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-year"></i> Monthly Breakdown
                </h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                {% for month in report_data.monthly_breakdown %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="fw-bold">{{ month.month }}</div>
                            <small class="text-muted">{{ month.transaction_count }} transactions</small>
                        </div>
                        <div class="text-end">
                            <div class="{% if month.summary.net_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ month.summary.net_balance | currency }}
                            </div>
                        </div>
                    </div>
                    {% if not loop.last %}<hr class="my-2">{% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Top Categories -->
        {% if report_data.category_breakdown %}
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-tags"></i> Top Categories
                </h5>
            </div>
            <div class="card-body">
                {% for category in report_data.category_breakdown[:8] %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="fw-bold">{{ category.category_name }}</div>
                            <small class="text-muted">
                                {{ category.transaction_count }} transactions
                                <span class="badge badge-sm {% if category.category_type == 'income' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ category.category_type }}
                                </span>
                            </small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold {% if category.category_type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                {{ category.total_amount | currency }}
                            </div>
                            <small class="text-muted">avg: {{ category.average_amount | currency }}</small>
                        </div>
                    </div>
                    {% if not loop.last %}<hr class="my-2">{% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent Transactions -->
{% if report_data.transactions %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list"></i> Recent Transactions
                </h5>
                <a href="{{ url_for('transactions_page') }}" class="btn btn-outline-primary btn-sm">
                    View All <i class="bi bi-arrow-right"></i>
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in report_data.transactions[:10] %}
                                <tr>
                                    <td>
                                        <div>{{ transaction.transaction_date | date_format('short') }}</div>
                                        <small class="text-muted">{{ transaction.transaction_date | relative_date }}</small>
                                    </td>
                                    <td>
                                        <span class="badge {% if transaction.type == 'income' %}bg-success{% else %}bg-danger{% endif %}">
                                            <i class="bi bi-{% if transaction.type == 'income' %}arrow-up{% else %}arrow-down{% endif %}"></i>
                                            {{ transaction.type.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if transaction.category_name %}
                                            {{ transaction.category_name }}
                                        {% else %}
                                            <span class="text-muted">No category</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if transaction.description %}
                                            {{ transaction.description }}
                                        {% else %}
                                            <span class="text-muted">No description</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <span class="fw-bold {% if transaction.type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                            {% if transaction.type == 'income' %}+{% else %}-{% endif %}{{ transaction.amount | currency }}
                                        </span>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
// Chart data
const reportData = {
    income: {{ report_data.summary.total_income }},
    expenses: {{ report_data.summary.total_expenses }},
    categories: {{ report_data.category_breakdown | tojsonfilter if report_data.category_breakdown else [] }}
};

// Income vs Expenses Pie Chart
const incomeExpenseCtx = document.getElementById('incomeExpenseChart').getContext('2d');
new Chart(incomeExpenseCtx, {
    type: 'doughnut',
    data: {
        labels: ['Income', 'Expenses'],
        datasets: [{
            data: [reportData.income, reportData.expenses],
            backgroundColor: [
                '#28a745', // Success green
                '#dc3545'  // Danger red
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed;
                        const total = reportData.income + reportData.expenses;
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                    }
                }
            }
        }
    }
});

// Category Breakdown Chart
{% if report_data.category_breakdown %}
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
const categoryLabels = reportData.categories.slice(0, 8).map(cat => cat.category_name);
const categoryData = reportData.categories.slice(0, 8).map(cat => cat.total_amount);
const categoryColors = reportData.categories.slice(0, 8).map(cat => 
    cat.category_type === 'income' ? '#28a745' : '#dc3545'
);

new Chart(categoryCtx, {
    type: 'bar',
    data: {
        labels: categoryLabels,
        datasets: [{
            label: 'Amount',
            data: categoryData,
            backgroundColor: categoryColors,
            borderColor: categoryColors,
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const category = reportData.categories[context.dataIndex];
                        return [
                            `Amount: $${context.parsed.y.toFixed(2)}`,
                            `Transactions: ${category.transaction_count}`,
                            `Average: $${category.average_amount.toFixed(2)}`
                        ];
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(0);
                    }
                }
            },
            x: {
                ticks: {
                    maxRotation: 45,
                    minRotation: 45
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}

